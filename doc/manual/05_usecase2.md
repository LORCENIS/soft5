Connecting REMARC to parScale
-----------------------------

In this example we demonstrate how to use data from an atomic scale simulation in **REMARC** as input to the particle scale model **parScale**, using **Porto**.

**TODO: Explain here why we need to connect these scales, use writing from Stefan Radl**


## Walkthrough

We assume that a simulation in REMARC has already been run and the simulation results have been stored in a *Porto Collection* with a unique identifier (*uuid*). This is described in the section _Run the REMARC simulation_. The uuid allows us to access the contents of the collection across different software and simulation tools.

Before we do the actual connection, we run the tool `inspectChemkinReactionEntity.js` which takes an uuid of a collection as argument. This allows us to inspect the contents of the Collection. In this example walkthrough we do this visual inspection in order to verify that the data is in place and that we are using the correct uuid. The following output is produced:

    $ ./inspectChemkinReactionEntity.js a6a71841-139a-4310-a9e6-ef7a6f161a6f
    Collection (uuid = a6a71841-139a-4310-a9e6-ef7a6f161a6f)
    |    Reactants => Products, A, b, Ea
    +--- CH4(S1) => CH4, 615900000000000000000, -2.54, 23.999
    +--- CH4 => CH4(S1), 7553000000, -0.5, 0

We note that, for this example, the Collection contains two reactions, including reactants and its products alongside key information about these reactions (_A_, _b_ and _Ea_). This is the _output_ of the REMARC simulation, and will be _input_ to the parScale simulation.

After we have inspected this collection and are satisfied with its contents, we can run the script that does the actual connection: `chemkinReactionEntity-to-chemkinFile.js`. Running this script with the same uuid as input gives us the following output:

    $ ./chemkinReactionEntity-to-chemkinFile.js a6a71841-139a-4310-a9e6-ef7a6f161a6f > Chemkin.inp
    $ cat Chemkin.inp
    ELEMENTS H C 
    END
    SPECIES
    CH4(S1) CH4
    END

    REACTIONS KJOULES/MOLE MOLES
    CH4(S1) => CH4 615900000000000000000 -2.54 23.999
    CH4 => CH4(S1) 7553000000 -0.5 0
    END 

We here see that the CHEMKIN II file has been populated with the reactions and their parameters, as inspected in the collection. This is now a file that contains the input needed to run parScale.

**TODO** How to run parScale with this file?

## Details

The source for these scripts can be found in the Porto repository under `porto/examples`. These scripts are meant to serve as examples of a range of techniques for connecting different software and can easilly be tailored towards other software, file types, data sets, entities and collections.

### `chemkinReactionEntity-to-chemkinFile.js`

`chemkinReactionEntity-to-chemkinFile.js` automates the following steps:

1. Access the Porto collection, referenced by the *uuid*.
2. Retrieve all reactions stored in the collection. Each reaction has the following information:
   * A list of reactants
   * A list of products
   * Pre-exponential factor $A$
   * $b$ (**TODO: Name?**)
   * Activation energy, $E_a$
3. From the list of reactants and products, generate the list of _elements_ and _species_ involved in the reactions.
4. Use the reaction along with the generated list of elements and species to populate a *CHEMKIN II* template. 
5. Store the filled template to a file.

### CHEMKIN II file format

CHEMKIN II files have the form (**TODO**)

**TODO: Does the file format exist somewhere else?**

### Chemkin reaction entity

**TODO: Described elsewhere?**


This has the following structure:

    ELEMENTS C H FE O 
    END
    SPECIES
    CH4 H2 CO2 H2O FE2O3 FE3O4
    END 
 
    REACTIONS KJOULES/MOLE MOLES
       CH4 + 3FE2O3 => CO + 2H2 + 2FE3O4    1.0e+14 0.0 100.0 
       CH4 + 12FE2O3 => CO2 + 2H2O + 8FE3O4 1.0e+18 0.0 180.0
    END 

The input file consists of three sections, each starting with a name and ending with the keyword `END`.

* `ELEMENTS` contains a list of elements noted by their periodic table names
* `SPECIES` contains a list of all species used in the reaction equations
* `REACTIONS` lists the possible reactions, followed by the pre exponential factor, b and activation energy. **Check**

This file is generated by
1. Accessing the base case entity by its UID.
2. Retrieving all reactions by its relation `reactiondata` (**TODO** Need some note on relations earlier?)
3. For each reaction, the reaction species and product species are noted in the entity property `reactants` and `products` respectively.
4. Produce a list of species from the list of reactants and products.
5. Produce a list of elements from the list of species.
6. Populate the CHEMKIN II template file, where the tags `@{soft.model.elements}`, `@{soft.model.species}` and `@{soft.model.reactions}` corresponds to the elements, species and reactions respectively.

A CHEMKIN II template file:

    ELEMENTS @{soft.model.elements}
    END
    SPECIES
    @{soft.model.species}
    END

    REACTIONS KJOULES/MOLE MOLES
    @{soft.model.reactions}
    END

parScale can take the produced CHEMKIN II file as an input.


ParScale -> Ansys FLUENT
------------------------

Demonstrate that data from the particle scale model parScale can be used in the generation of an Ansys FLUENT UDF using Porto. 


* Simulate reaction and record (i) average particle temperature, (ii) current total consumption rate of gas-phase species A, and (iii) conversion of the solid
* Postprocessing step 1: calculate and plot (i) consumption rate of A versus conversion X for different C_A. Repeat exercise for different temperature to determine k, m, and n.
* Calculate the fitting values for k, n and m in the rate expression
* The effectiveness factor (parameters k_fit and m, as well as the functional form) is written to a .json file from an Octave script that processes the ParScale output
* then read into Porto using an External Plugin

(Alternative approach, if feasible: Ef is written directly from ParScale using Porto. We will investigate whether this is a feasible approach within the time available.)

* Porto stores Ef in an entity
* An UDF for Fluent is generated using the UDF generation in Porto

Stefan Radl will create an UDF template for the effectiveness factor.




----------
NOTES: To be removed
====================


Connecting scales with Porto
============================

One scenario (uid)
Allows re-tracing steps, re-running simulations
Porto stores data in database, programs can interact directly through the Porto API from applications or through scripting
Porto -> input -> simulation -> output -> Porto
Semantics of data defined in entities

The connection from WP3 to WP4 will be the following:
* Retrieve the activation energy from Remarc, using Porto
* Write Chemkin file for use in ParScale
* The Chemkin file will be generated using Porto and can be fully generated from the reaction entity from Remarc. This is analogue to the WP3 -> WP5 connection demonstrated.
* The individual workflows for WP3 -> WP4 and WP4 -> WP5 can be combined to form a full workflow for WP3 -> WP4 -> WP5.
* Stefan Radl will define a simplified reaction that allows us to demonstrate this connection.

Example file:

    ELEMENTS H O N END
    SPECIES H2 H .....
    Reaction (H2 + O = H2), Pre-exponential factor, temperature exponent and activation energy



From Stefan Radl
-----


## 3 Effective Reaction Model
The reaction rate law is written such that the key gas phase reactant (denoted as reactant A) is consumed and has the stoichiometric factor of -1. All other reactants may have a different stoichiometric factor.
  
The reaction may be of order n with respect to species A, and of order m with respect to a solid-phase reactant that is consumed during the reaction. The concentration of the solid-phase reactant is assumed to be proportional to (1-X) where X is the conversion. Consequently, the rate law (which equals the rate of consumption of species A) is written as
 
where k is the reaction rate constant (currently this value is assumed to be constant and equal to "effectiveArrhenius").

In order to close the model, the local conversion X of the particles has to be tracked. Starting initially with 0, the time evolution of X follows directly from the consumption of the solid species (with the initial concentration Cs,0) and hence is
 
Here dt denotes the material derivative of X.

### 3.1 Future Extension
The reaction rate constant k may depend on the local temperature via Arrhenius law. This can be achieved by supplying more data to "effectiveArrhenius"

Based on the local reaction rate a Thiele modulus could be calculated:
 
Here Deff is the effective diffusivity of gas phase species A in the pores, which may depend on the local temperature.  is the particle diameter. This Thiele modulus can be used to close a more advanced effectiveness factor model.


## 4	Closing the Single Reaction Model
Note that k, m, and n can be specified by the user (if it is clear which reaction is dominating), or are the result of a fitting exercise using a simulation of a more complex reaction or reaction network (using, e.g., ParScale). For the latter the rate expression may be linearized following
 
Thus, multivariate linear regression (e.g., using Octave’s ‘ols’ function) can be used to determine k, m, and n. http://stats.stackexchange.com/questions/32504/simple-multivariate-regression-with-octave. In the present work, m is set to zero to avoid the additional complication of running multiple ParScale simulations. However, the parameter n will be fitted by ParScale’s postprocessing tool.

## 5	Overall Model for Reaction in Control Volume (for Application in WP5)

The overall volumetric consumption rate of the gas phase species A (in [kmol/m³/s]) is 

_Equation_

where p is the particle volume fraction. This rate expression must be implemented in the Fluent UDF.
Thus, the user input to the UDF is:

* the parameters to model k as a function of temperature (e.g., (i) a constant value, or (ii) using the Arrhenius law that considers a pre-exponential factor and an activation energy which can be supplied by a Porto “reaction” entity)
* the parameters m and n to model the effective reaction rate, 
* the functional form of (can be a constant, or a more elaborate mathematical expression, e.g., that shown in the first chapter)
* the parameters to model the effective diffusivity (in the simplest case this is not needed; the effective diffusivity is only needed if a complex functional form for the effectiveness factor is chosen) 
* the initial concentration and stoichiometric factor of the solid to be able to calculate X (in the simplest case this is not needed; only needed if a complex functional form for the effectiveness factor is chosen)

| Tables        | Are           | Cool  |
| ------------- |:-------------:|------:|
| col 3 is      | right-aligned | $1600 |
| col 2 is      | centered      |   $12 |
| zebra stripes | are neat      |    $1 |

